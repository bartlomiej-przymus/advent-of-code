<?php

$testInput = "........#.............................................#.........#..............#.......#....................#....................#
......................#........#........................#.............##............................#.#.............#..........#..
....#..................................#..................#.........#....#..............#..#......................#........#...#..
.....#...#...............#................#..........................#......#.....................#.......................#.......
......................................................##.#....#..................................................................#
#....#....................#..................................#.....................................#......................#.......
.......#...........................#.......................#......#...#.................................................#...#.....
....................##..........................#................#..........................#.#..................#....#.........#.
#..................................#...............#...............#.........................#............##......................
.............................#....................................#...............#.........#..........#.......................#..
.................................#............###.......#............##......#...............................#...............#.#..
.#..........................................#.......#.......................##..#........#........#...............#...............
......#...#............#.#..............#...................#..........................................................##.........
#................##....................................................................#........#.................#...#...........
...#..........#..........................##......#....#..............................#......................................#.....
..............................##.#..........................................................#..............................#......
......#...........#....#..................#............#....................................................................#.....
.....................#........................#.......................................................#...........................
...................#.#..........................................................................................#.#...............
.........................................##.........................................................#.......#...###......#........
...............................................................##.......................#..........................#..............
...#...........#.................#..............#......#.....#..........................#....................#....#...............
.................................#................#................#..............................................#.......##.....#
........#..........................#................#.......................#...................#.................................
.............................#.............................#..........#.........................#........#........................
....#................#.#................#...........................................................#...#....#......#......#......
........#..............................#...............................#.................#........................................
...........................................#..#........#...#...........#..#.............#.........................................
.#.................#.#................................#................#.#..................................#........#............
.......#..........................................#.................................................................#.............
...................#....................................................#..#...............................................#......
...#.#........#...#.....#.....................................................................................................#...
......#.........................#......................#.............#.....................#......................................
..........................#............#.................................#..#..........#........#......................#..........
...#..#......#.......................#........................#...................................................................
............#...........#................#..............#.........................................................................
.#........#....#.........................................#........................................#...............................
...#......................##.........#.......#.#...........#................................................#...#.................
...........#......#.........#....#.....#.......................................................#.............#....................
.............#...#..............................................#.........#.....##....................#...#.........#.............
...............#................................#..........................................#.....#.#.........................#...#
................#.....#..#.............#..............#..............#.......#....................................................
......#.........................................................................................................#.........##......
..#...........................#.#...........................................#..#.....#............................................
...#...#..................#..................................#.........#...................#..................................#...
............#..#.....................#.........................................#.......#..................................#.......
...#.......................................................................#.............................#........................
......#..................#....................................#......##...........................................................
.#...............#.....#..........................................................................................#...............
...#.............#.........................#.....................#...#..........#....#............................#...............
...#............................#.......#...........#.........#........#.....#...........#...................................#....
.....................#...................#................................#...............................#......#.........#..##..
.............#........................................................................................#........................##.
.....#.......#.......#............................................................................................................
............................................#................................................................#..............#.....
....#..#......................................................#...................................................#...............
.................................#...##..................#.................................................#....#.................
........#...................................#...#..........................................................#......................
........................#........##...........#.......#........#...................................#..............................
...........#...#...................................................#..............#......#...............#.#..................#...
........#.............................................#...........................................................................
........#................#......#..........#..#........#.#.......#...#........................#..#......................#.......#.
.......#..........................................................................................................#.....#.....#...
......................##....................#.....#.................#...........#.......................#.##..........#......#....
....................................##....................................................................#.................#.....
..#.................................#.#...........#............................................#....#.............................
#...................................#...........................................#............#.........#...............#..........
.......................#.............................................................#..........#...#.............#.....#.........
#..................#.#.............................................................................#.................#............
.....................#......#.......#...........#..........................................^...............................#......
................................#......................#.#.....#..............#..................#....#.#......#....#.............
............................................................................#........#.....................................#......
.............#......................................................#...................................#......##..#....#.........
...............#.................#...................#...............#............................................................
..............#...........#..#...........................................#...................................#..........#.........
..........#...........................#...................#..............#...#.......#..........#...................#.............
.............#.#..................................#....#..#............#.....................#................#...#.....#.........
...................#..........................................................#............##.....................................
...........................................#............#........................................................................#
..#..............................#....#...........................................................................................
..#..#............#...........................#...#...........#............#.....#.................#..............................
....#...................#.........#...............................................................................................
.......#..........................#....................................##........#.................##...#.#........#..#...........
.#........................#....#.......#.....#...................#.............................................#..................
..#...............................................................#................................................#..............
.....#........................................#...................................................................................
..........................................#..........................................................#............................
....................###.........................#............................#...#...........#............#.......................
.....#.....#...............#........#.#....#...................#...........#........#...........#.................................
................................................................................................#...##............................
......................#............#.........................#.......................#.....#...........#...#.#....................
............................#....................#..................#..............#..................................#...........
...........................#...................................#..............................................................#...
..................#................#.....................#...................#........#..............#............................
............#.............#.....................#..................#.........#......................#............#............#...
....#..........................#...............................................................................................#..
................#.....................................#.............................#...........#........................#........
#.##...........#.........................................#...............#..........................................#.#...........
........................................#..............#.....................#............#.....#.................................
.......#....##..#..#.....#........................................................................................................
....##.............#..............................#...............................................................................
.....#........................#.........#..#......#........#......................#.......#..............#..........#.......#.....
..#....#.........................#.#....................#..#.......#.............#..................#........#..................#.
..........##....#........................................................................#........................................
........#......#................................................................................................#................#
.....#.......#...#.............#....................................#..#........................#...#..............#....#.........
.............#...................................................##...#...........................................................
..............#.............................................#.............#................#.............#..............#.........
..#....#..........#.....#......#......................#................................#...............................#..........
.................................................................................##......#...........................#.....#......
..#....#..........#.......#.........................................#...............#..#............................#........#....
...........#........#.#....................#........#.....................................#..................#....................
.......#............#................#...........#.............#......#.........#...........................#.....................
#.#....#.#...............#....#.....#.......................#...............................#...................##...#............
.................##...#.................................................................#...........................#.............
.....#........................................#.........#...................................................#.....................
....................#.....................#................................................#...##.....................#...........
...............#...............................................................#....#.............................................
.................#................#...#.....................................#......#....................#...............#.#.......
...................#............................................#..#....#..#........#...............................#.........#...
..#........#...............#..................#.....#..................#.....................................#........##...#......
.....#.....#....#.....#................#.#.....................##.............................................................#...
................#............#......#......#.......................................................#....................#........#
........#..............#..#......................................................................##.....##........................
.........#.............................#.........#.......................................#..........................#.##..........
.#...................#........................................................#....#......................................#.......
....#..........#.....#.........................................................................................#..................
.......#.............................#............#.........................#....#....#........#......#.....#.......#.............
..#.......#........................#........................#.....................................................................
........................#...............................#.#.............#................................#..................#.....";

foreach(explode("\n", $testInput) as $row) {
    $grid[] = str_split($row);
}

foreach($grid as $rowIndex => $row) {
    foreach ($row as $columnIndex => $column) {
        if ($column == '#') {
            $wallLocations[] = [$rowIndex, $columnIndex];
        }

        if ($column == '^') {
            $guardPosition = array_map('intval', [$rowIndex, $columnIndex]);
        }
    }
}

class Guard
{
    private string $direction = 'north';
    private int $column;
    private int $row;
    private array $listOfVisitedPositions = [];
    private int $maxRow;
    private int $maxColumn;

    public function __construct(
        public array $pos,
        public array $wallLocations,
        public array $areaBounds,
    ) {
        $this->maxRow = $this->areaBounds[0];
        $this->maxColumn = $this->areaBounds[1];

        $this->row = $pos[0];
        $this->column = $pos[1];

        $this->setVisitedPositions([$this->row, $this->column]);
    }

    public function isInArea(): bool {
        $pos = $this->getPosition();
    return
        $pos[0] >= 0 &&
        $pos[1] >= 0 &&
        $pos[0] < $this->maxRow &&
        $pos[1] < $this->maxColumn;
    }

    public function canMoveNorth(): bool {
        if($this->direction == 'north') {
            $newPosition = [$this->row - 1, $this->column];

            foreach($this->wallLocations as $wallLocation) {
                if ($wallLocation[0] == $newPosition[0] && $wallLocation[1] == $newPosition[1]) {
                    $this->direction = 'east';

                    return false;
                }
            }

            return true;
        }

        return false;
    }

    public function canMoveSouth(): bool {
        if($this->direction == 'south') {
            $newPosition = [$this->row + 1, $this->column];

            foreach($this->wallLocations as $wallLocation) {
                if ($wallLocation[0] == $newPosition[0] && $wallLocation[1] == $newPosition[1]) {
                    $this->direction = 'west';

                    return false;
                }
            }

            return true;
        }

        return false;
    }

    public function canMoveEast(): bool {
        if($this->direction == 'east') {
            $newPosition = [$this->row, $this->column + 1];

            foreach($this->wallLocations as $wallLocation) {
                if ($wallLocation[0] == $newPosition[0] && $wallLocation[1] == $newPosition[1]) {
                    $this->direction = 'south';

                    return false;
                }
            }

            return true;
        }

        return false;
    }

    public function canMoveWest(): bool {
        if($this->direction == 'west') {
            $newPosition = [$this->row, $this->column - 1];

            foreach($this->wallLocations as $wallLocation) {
                if ($wallLocation[0] == $newPosition[0] && $wallLocation[1] == $newPosition[1]) {
                    $this->direction = 'north';
                    return false;
                }
            }

            return true;
        }

        return false;
    }

    public function walkNorth(): void
    {
        $this->row--;
        $this->setVisitedPositions([$this->row, $this->column]);
    }

    public function walkSouth(): void
    {
        $this->row++;
        $this->setVisitedPositions([$this->row, $this->column]);
    }

    public function walkWest(): void
    {
        $this->column--;
        $this->setVisitedPositions([$this->row, $this->column]);
    }

    public function walkEast(): void
    {
        $this->column++;
        $this->setVisitedPositions([$this->row, $this->column]);
    }

    public function setVisitedPositions(array $position): void
    {
        $exists = false;
        foreach($this->listOfVisitedPositions as $visited) {
            if ($visited[0] === $position[0] && $visited[1] === $position[1]) {
                $exists = true;
                break;
            }
        }

        if (!$exists && $this->isInArea($position)) {
            $this->listOfVisitedPositions[] = $position;
        }
    }

    public function getPosition(): array {
        return [$this->row, $this->column];
    }

    public function getNumberOfUniqueVisitedPositions(): int
    {
        return count($this->listOfVisitedPositions);
    }

    public function getVisitedPositions(): array
    {
        return $this->listOfVisitedPositions;
    }
}

$areaBounds = [count($grid), count($grid[0])];

$guard = new Guard($guardPosition, $wallLocations, $areaBounds);

function isInArea($pos, $areaBounds): bool
{
    return
        $pos[0] >= 0 &&
        $pos[1] >= 0 &&
        $pos[0] < $areaBounds[0] &&
        $pos[1] < $areaBounds[1];
}

while(isInArea($guard->getPosition(), $areaBounds)) {
    //starting facing forward so we check what is in front.
    if ($guard->canMoveNorth() && isInArea($guard->getPosition(), $areaBounds)) {
        $guard->walkNorth();
    } elseif ($guard->canMoveEast() && isInArea($guard->getPosition(), $areaBounds)) {
        $guard->walkEast();
    } elseif ($guard->canMoveSouth() && isInArea($guard->getPosition(), $areaBounds)) {
        $guard->walkSouth();
    } elseif ($guard->canMoveWest() && isInArea($guard->getPosition(), $areaBounds)) {
        $guard->walkWest();
    }
}
//4515
echo "Found guard at : " . implode(', ', $guardPosition) . "\n";
echo "number of steps: " . $guard->getNumberOfUniqueVisitedPositions() . "\n"; //the last position outside of map does not count

//part2
//die();
$positionsVisitedByGuard = $guard->getVisitedPositions();

function patrol(Guard $guard, $areaBounds): string {
    $maxSteps = 7000;
    $stepCount = 0;

    while(isInArea($guard->getPosition(), $areaBounds) && $stepCount < $maxSteps) {

        if ($guard->canMoveNorth() && isInArea($guard->getPosition(), $areaBounds)) {
            $guard->walkNorth();
        } elseif ($guard->canMoveEast() && isInArea($guard->getPosition(), $areaBounds)) {
            $guard->walkEast();
        } elseif ($guard->canMoveSouth() && isInArea($guard->getPosition(), $areaBounds)) {
            $guard->walkSouth();
        } elseif ($guard->canMoveWest() && isInArea($guard->getPosition(), $areaBounds)) {
            $guard->walkWest();
        }

        $stepCount++;
    }

    if(isInArea($guard->getPosition(), $areaBounds)) {
        return 'stuck';
    }

    return 'finished';
}

array_shift($positionsVisitedByGuard); // remove first location as we cannot place anything there

foreach($positionsVisitedByGuard as $obsIndex => $obstacleLocation) {
    $amountOfObstacles = count($positionsVisitedByGuard);

    array_unshift($wallLocations, $obstacleLocation);

    $guard = new Guard($guardPosition, $wallLocations, $areaBounds);

    //place obstacle at location and run the loop

//
    if(patrol($guard, $areaBounds) == 'stuck') {
        echo "This is run: $obsIndex out of $amountOfObstacles \n";
        $obstacleLocations[] = [$obstacleLocation[0] => $obstacleLocation[1]];
    }

    array_shift($wallLocations);
}
//
echo "amount of possible obstacles to cause the loop: " . count($obstacleLocations) . "\n";
